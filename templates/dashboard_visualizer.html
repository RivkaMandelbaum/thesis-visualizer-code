{% block stylesheets %}
  <script src="https://use.fontawesome.com/ffb1fe552d.js"></script>
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="{{ url_for('static', filename='vis@4.17.0/dist/vis-network.min.css') }}" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" type="text/css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" type="text/css">
{% endblock %}
{% block head %}
<head>
  <title>Network Visualization</title>
</head>
{% endblock %}
{% block body %}
<h1>Network Visualization</h1>
<div id="visualizer-wrapper" class="d-flex justify-content-between align-items-stretch">
  <aside id="sidebar">
    <button id="refresh" onclick="window.location.reload();">Refresh</button>
    <div id="settings-pane" class="sidebar-pane">
      <h2>Settings</h2>
      <div class="sub-pane">
        <h3>Degree</h3>
          <input type="number" id="degree" name="degree" min={{degree_min}} max={{degree_max}} placeholder={{degree_placeholder}}>
      </div>
      <div class="sub-pane">
        <h3>Trial Maker ID</h3>
        <form action="index" method="get">
          <select name="trial-maker-id" id="trial-maker-id" onchange=this.form.submit()>
            {% for trialmaker_option in trialmaker_options %}
              <option value={{trialmaker_option}}>{{trialmaker_option}}</option>
            {% endfor %}
          </select>
      </form>
      </div>
      <div class="sub-pane">
        <h3>Show Infos</h3>

        <input type="checkbox" id="show-infos" name="show-infos" {{show_infos_checked}} onchange="document.getElementById('show-infos-off').value = this.checked ? 'off' : 'on';">

        <input type="text" id="show-infos-off" name="show-infos-off" style="display:none">
      </div>
      <div class="sub-pane">
        <h3>Graph Seed</h3>
        <input type="text" id="seed" name="seed">
      </div>
      <div class="sub-pane">
        <h3>PyVis Physics</h3>
        <select name="physics" id="physics">
          {% for physics_option in physics_options %}
            <option value={{physics_option}}>{{physics_option}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="sub-pane">
        <h3>Hide Non-Neighbors</h3>
        <input type="checkbox" id="hide-non-neighbors" name="hide-non-neighbors">
      </div>
    </div>
    <div id="search-pane" class="sidebar-pane">
      <input type="number" placeholder="Find Node By Vertex ID" min={{find_min}} max={{find_max}}>
    </div>
  </aside>
  <main class="flex-fill">
    <section id="mynetwork">
      <h2>Graph</h2>
      <div id="graph"> {{ graph | safe }} </div>
    </section>
    <section id="details-pane">
      <h2>Details</h2>
      <div id="element-details">
        <div id="details-content">
          {%for para in content %}
            {{para}}<br>
          {% endfor %}
        </div>
          <input type="text" id="clicked-node-input" name="clicked-node" style="display:none">
      </div>
    </section>
  </main>
  <script src=
   "https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js">
    </script>
  <script>
    'use strict';

    function handleGraphResponse(response) {
      $('#mynetwork').html(response);
    }

    function handleContentResponse(response) {
      $('#details-content').html(response);
    }

    function setCookieRequest(clickedNode) {
      request = $.ajax(
          {
            type:'GET',
            url: '/setclickednode?id=' + clickedNode
          }
        )
    }

    let request = null;

    function getGraph() {

      // get name value pairs for url
      let degree = encodeURIComponent($('#degree').val());
      let showInfos = encodeURIComponent($('#show-infos').is(":checked"));
      let clickedNode = encodeURIComponent(document.getElementById("clicked-node-input").value);

      // check for conditions under which graph shouldn't reload:
      // info was clicked on
      let is_info = (clickedNode[0] === "i");
      if (is_info) {
        setCookieRequest(clickedNode);
        return
      }

      // node was already clicked on
      let clickedCookie = (document.cookie
        .split('; ')
        .find((row) => row.startsWith('clicked-node='))
        ?.split('=')[1]);

      if (clickedNode === clickedCookie) {
        setCookieRequest(clickedNode);
        return
      }

      // previously clicked node was an info and this is its origin
      if (clickedCookie[0] === "i") {
        let originId = nodes.get(clickedCookie)["origin_id"];
        if (originId != undefined) {
          let originNodeId = "n" + originId;
          if (clickedNode === originNodeId) {
            setCookieRequest(clickedNode);
            return
          }
        }
      }

      // make url and send request
      let url = '/getgraph?degree=' + degree + '&show-infos=' + showInfos + '&clicked-node=' + clickedNode;

      if (request != null) request.abort();

      request = $.ajax(
        {
          type:'GET',
          url: url,
          success: handleGraphResponse
        }
      )
    }

    function getContent() {
      // get relevant name-value pairs for url
      let exp = (document.cookie
        .split('; ')
        .find((row) => row.startsWith('exp='))
        ?.split('=')[1]);

      let clickedNode = encodeURIComponent(document.getElementById("clicked-node-input").value);

      // check if the node was already clicked on (no need to reload)
      let clickedCookie = (document.cookie
        .split('; ')
        .find((row) => row.startsWith('clicked-node='))
        ?.split('=')[1]);

      if (clickedNode === clickedCookie) {
        setCookieRequest(clickedNode);
        return
      }

      // make url and send request
      let url = '/getcontent?exp=' + exp + '&clicked-node=' + clickedNode;

      request = $.ajax(
        {
          type:'GET',
          url: url,
          success: handleContentResponse
        }
      )
    }

    function setup() {
      $('#degree').on('input', getGraph);
      $('#show-infos').on('change', getGraph);
    }
    $('document').ready(setup);
  </script>
  </div>
{% endblock %}